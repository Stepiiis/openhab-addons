<?xml version="1.0" encoding="UTF-8"?>
<thing:thing-descriptions bindingId="energymanager"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:thing="https://openhab.org/schemas/thing-description/v1.0.0"
	xsi:schemaLocation="https://openhab.org/schemas/thing-description/v1.0.0 https://openhab.org/schemas/thing-description-1.0.0.xsd">

	<thing-type id="signalizator">
		<label>Energy Manager Service</label>
		<description>Monitors energy flows and signals availability for activating loads based on surplus and
			configuration.
		</description>

		<config-description>
			<!-- Required configuration -->
			<parameter name="refreshInterval" type="integer" min="10" required="true">
				<label>Refresh Interval (seconds)</label>
				<description>How often to evaluate energy status and update output signals.</description>
			</parameter>
			<parameter name="peakProductionPower" type="integer" min="0" required="true">
				<label>Nominal (peak) electricity production power (W)</label>
				<description>Used to calculate potential surplus if grid feed in is not permitted (or limited) at the point in
					time.
				</description>
			</parameter>

			<!-- Required configuration of used item names or static value -->
			<parameter name="minStorageSoc" type="text" required="true">
				<label>Minimal SOC</label>
				<description>
					Do not signal surplus availability if Battery SOC is below the value of the linked Item.
					Set as integer
					if dynamic setting using an item is not needed.
				</description>
				<default>20</default>
			</parameter>
			<parameter name="maxStorageSoc" type="text" required="true">
				<label>Maxiamal SOC</label>
				<description>
					Link to Item representing maximum ESS SOC (in Percent, 0-100).
					Set as integer if dynamic setting using
					an item is not needed.
				</description>
				<default>100</default>
			</parameter>

			<!-- Required configuration of used item names -->
			<parameter name="productionPower" type="text" required="true">
				<label>Item production power (W)</label>
				<description>Name of Item representing current local generation power (in Watts, positive).</description>
			</parameter>
			<parameter name="storageSoc" type="text" required="true">
				<label>Item ESS SOC (%)</label>
				<description>Name of Item representing Battery SOC (in Percent, 0-100).</description>
			</parameter>
			<parameter name="storagePower" type="text" required="true">
				<label>ESS power (W)</label>
				<description>Name to Item representing ESS power draw (in Watts, negative=discharging, positive=charging).
				</description>
			</parameter>
			<parameter name="electricityPrice" type="text" required="true">
				<label>Current electricity price</label>
				<description>
					Name of Item representing the current electricity price (e.g., EUR/MWh or unitless).
					Has to be the same
					unit as configuration parameters of the output channels.
				</description>
			</parameter>

			<!-- Optional configuration -->
			<parameter name="minAvailableSurplusEnergy" type="integer" min="0" required="false">
				<label>Minimum surplus energy threshold (W)</label>
				<description>
					This value is subtracted from calculated surplus.
					Use this to specify amount of energy *always*
					available for e.g. ESS or grid feed in.
				</description>
				<default>0</default>
			</parameter>
			<parameter name="toleratedPowerDraw" type="integer" min="0" required="false">
				<label>Tolerated draw from grid or ESS (W)</label>
				<description>This value is used to smooth out surplus calculation due to operating power draw from the grid or ESS.
					Use with caution.</description>
				<default>0</default>
			</parameter>
			<parameter name="initialDelay" type="integer" min="30" required="false">
				<label>Initial delay (seconds)</label>
				<description>Initial delay after configuration loads before the actual evaluation starts.</description>
				<default>60</default>
			</parameter>
			<parameter name="toggleOnNegativePrice" type="boolean" required="false">
				<label>Auto negative price</label>
				<description>
					Toggle all output channels if the price of electricity is negative regardless of the current local
					production capacity.
				</description>
				<default>true</default>
			</parameter>
			<parameter name="enableInverterLimitingHeuristic" type="boolean" required="false">
				<label>Enable heuristic to calculate surplus</label>
				<description>
					Experimental feature which enables calculation of surplus energy once the maximum SOC of the ESS
					is
					reached. If there is some production and there is no energy going from or to the grid, it
				</description>
				<default>false</default>
			</parameter>
		</config-description>
	</thing-type>

	<channel-type id="surplus-output">
		<item-type>Switch</item-type>
		<label>Surplus availability signal</label>
		<description>Indicates (ON/OFF) if sufficient surplus energy is available for a specific load.</description>
		<state readOnly="true" pattern="%s"/>

		<config-description>
			<parameter name="priority" type="integer" min="1" required="true">
				<label>Load priority</label>
				<description>
					Load priority (1 = highest). Higher priority loads are considered first.
					Duplicate priorities lead to
					undefined order.
				</description>
			</parameter>
			<parameter name="loadPower" type="integer" min="0" required="true">
				<label>Load power (W)</label>
				<description>The power consumption of the load controlled by this signal.</description>
			</parameter>
			<parameter name="minRuntimeMinutes" type="integer" min="0" required="false">
				<label>Min runtime (minutes)</label>
				<description>Minimum time the load must stay ON once activated (0 = disabled).</description>
				<default>0</default>
			</parameter>
			<parameter name="minCooldownMinutes" type="integer" min="0" required="false">
				<label>Min Cooldown (minutes)</label>
				<description>Minimum time the load must stay OFF once deactivated (0 = disabled).</description>
				<default>0</default>
			</parameter>
			<parameter name="maxElectricityPrice" type="decimal" required="false">
				<label>Max acceptable price of electricity</label>
				<description>Do not activate load if electricity price exceeds this value (empty = disabled).
				</description>
				<context>number</context>
			</parameter>
		</config-description>
	</channel-type>

</thing:thing-descriptions>
